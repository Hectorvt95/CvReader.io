<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} + ' - My Website'">Home - CvReader</title>
    <link rel="icon" th:href="@{/images/logo_brain_bw_header.png}" href="/home">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" th:href="@{/css/styles-jobs.css}">
    <!--<link rel="stylesheet" href="C:\Users\marti\OneDrive\Documents\NetBeansProjects\DistSyst\CvReader\src\main\resources\static\css\styles.css">-->
    
</head>
<body>
        
    <div class="cvreader-container">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <img class ="navbar-brand" th:src="@{/images/logo_nobg.png}" alt= "Logo" href="/";>
                <button class="button_box" >
                    <a class="nav-link" href="/contact">Contact Us</a>
                </button>

            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero-section" style="min-height: auto; padding: 20px 0;">
            <div class="container">
                
                <!-- Loading Message -->
                <div id="loadingMessage" class="text-center" style="display: none;">
                    <h2 class="welcome-message">Loading Database jobs...</h2>
                    <i class="fa fa-spinner fa-spin fa-3x" style="color: white; margin-top: 20px;"></i>
                </div>
                
                <!-- No Jobs Message -->
                <div id="noJobsMessage" class="no-jobs-container" style="display: none;">
                    <i class="fa fa-database fa-4x" style="color: #ddd; margin-bottom: 20px;"></i>
                    <h2>No Jobs in Database</h2>
                    <p>No job data found in the database. Upload a resume and click "View All Jobs" to save jobs here.</p>
                    <a href="/" class="btn btn-primary btn-lg">
                        <i class="fa fa-upload"></i> Upload Resume
                    </a>
                </div>
                
                <!-- Database Error Message -->
                <div id="errorMessage" class="no-jobs-container" style="display: none;">
                    <i class="fa fa-exclamation-triangle fa-4x" style="color: #dc3545; margin-bottom: 20px;"></i>
                    <h2>Database Error</h2>
                    <p id="errorText">Unable to connect to database.</p>
                    <button onclick="loadDatabaseJobs()" class="btn btn-warning btn-lg">
                        <i class="fa fa-refresh"></i> Retry
                    </button>
                </div>
                
                
                <!-- Jobs Content -->
                <div id="jobsContent" style="display: none;">
                    <!-- Header -->
                    <div class="text-center" style="margin-bottom: 30px;">
                        <h1 class="display-4 fw-bold welcome-message" th:text="${message}">Jobs from Database</h1>
                        <h2 class="lead" style="color: white;" id="jobsSubtitle" th:text="${submessage}">All stored job opportunities</h2>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="stats-container">
                        <div class="row">
                            <div class="col-md-4">
                                <h3 id="totalJobs">0</h3>
                                <p>Total Jobs</p>
                            </div>
                            <div class="col-md-4">
                                <h3 id="totalSources">0</h3>
                                <p>Job Sources</p>
                            </div>
                            <div class="col-md-4">
                                <h3 id="displayedJobs">0</h3>
                                <p>Displayed</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Skills Display -->
                    <div class="skills-display" id="skillsInfo">
                        <h4><i class="fa fa-tags"></i> Skills from Latest Upload:</h4>
                        <div id="skillsContainer">
                            <em>Loading skills...</em>
                        </div>
                    </div>
                    
                    <!-- Export & Management Buttons -->
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportToCSV()">
                            <i class="fa fa-download"></i> Export to CSV
                        </button>
                        <button class="export-btn" onclick="printJobs()">
                            <i class="fa fa-print"></i> Print
                        </button>
                        <button onclick=goToUploadPage() class="new-search-btn">
                            <i class="fa fa-upload"></i> Upload Another Resume
                        </button>
                        <button class="export-btn" onclick="clearDatabase()" style="background: #dc3545;">
                            <i class="fa fa-trash"></i> Clear Database
                        </button>
                    </div>
                    
                    <!--jobs container in table-->
                    <div class="jobs-table-container" id="jobsTableContainer">
                        <div class="table-header">
                            <h3><i class="fa fa-list"></i> Database Job Listings</h3>
                            <div class="table-info">
                                <span id="tableInfo">Showing all jobs</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="jobs-table" id="jobsTable">
                                <thead>
                                    <tr>
                                        <th>
                                            Job Title 
                                        </th>
                                        <th>
                                            Company 
                                        </th>
                                        <th>
                                            Location 
                                        </th>
                                        <th>
                                            Source 
                                        </th>
                                        <th>
                                            Salary 
                                        </th>
                                        <th>
                                            Posted Date 
                                        </th>
                                        
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <!-- Job rows will be dynamically generated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="cvreader-footer">

            <div class="footer-content">

                <div class="footer-left">

                    <div >

                        <div class="brain-icon">
                            <img class= "brain-icon" th:src="@{/images/logo_brain_bw.jpg}" alt= "Logo" href="/home"/>
                         
                        </div>

                    </div>
                    
                    <div class="social-icons">
                        <a href="https://www.facebook.com/hector.valletapia" target="_blank" class="social-link">
                          <img class="fb-social-link" th:src="@{/images/fb_logo.png}" alt= "Logo" href="/home"/>
                        </a>
                        <a href="https://www.instagram.com/hectormvt" target="_blank" class="social-link">
                          <img class="social-link" th:src="@{/images/insta_logo.png}" alt= "Logo" href="/home"/>
                        </a>
                        <a href="https://www.linkedin.com/in/hectorvalle95" target="_blank" class="social-link">
                          <img class="social-link" th:src="@{/images/x_logo.png}" alt= "Logo" href="/home"/>
                        </a>
                      </div>

                </div>

                <div class="footer-right">
                    <div class="footer-links">
                      <a href="/contact" class="footer-link">Contact Us</a>
                    </div>
                </div>

            </div>

        </footer>

    </div>   
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables to store job and skills data
         let allDatabaseJobs = [];
        let displayedJobs = [];
        let allFilenames = [];
        let allSources = [];
        let currentSkills = null;
        
        function goToUploadPage(){
            window.location.href='/';
        }
        
        function formatSkillsDisplay(skills) {
            if (!skills || skills.length === 0) {
                return '<em>No skills detected</em>';
            }
            
            let skillsArray = [];
            skillsArray = skills.split(',').map(s => s.trim()).filter(s => s.length > 0);
            
            const skillBadges = skillsArray.map(skill => 
                `<span class="skill-badge">${escapeHtml(skill)}</span>`
            ).join(' ');

            return skillBadges;
        }

        // Function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to get unique skills from selected jobs
        function getSkillsFromSelectedJobs() {
            const selectedFilename = document.getElementById('filenameFilter').value;
            
            if (selectedFilename === 'all') {
                // If showing all files, show skills from most recent upload
                showDefaultSkills();
                return;
            }
            
            // Find jobs for the selected filename and get their skills
            const jobsForFile = allDatabaseJobs.filter(job => getFilenameFromJob(job) === selectedFilename);
            
            if (jobsForFile.length > 0) {
                // Get skills from the first job (they should all have the same skills for the same file)
                const skillsData = getSkillsFromJob(jobsForFile[0]);
                
                if (skillsData) {
                    currentSkills = skillsData;
                    document.getElementById('skillsInfo').style.display = 'block';
                    document.querySelector('.skills-display h4').innerHTML = 
                        `<i class="fa fa-tags"></i> Skills from Selected CV (${selectedFilename}):`;
                    document.getElementById('skillsContainer').innerHTML = formatSkillsDisplay(skillsData);
                } else {
                    document.getElementById('skillsInfo').style.display = 'block';
                    document.querySelector('.skills-display h4').innerHTML = 
                        `<i class="fa fa-tags"></i> Skills from Selected CV (${selectedFilename}):`;
                    document.getElementById('skillsContainer').innerHTML = '<em>No skills detected for this CV</em>';
                }
            } else {
                document.getElementById('skillsInfo').style.display = 'none';
            }
        }

        // Load jobs from database on page load
        async function loadDatabaseJobs() {
            console.log('Loading jobs from database...');
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('jobsContent').style.display = 'none';
            document.getElementById('noJobsMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                const response = await fetch('/db/api/jobs');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.jobs) {
                    allDatabaseJobs = result.jobs;
                    displayedJobs = [...allDatabaseJobs];
                    
                    if (allDatabaseJobs.length > 0) {
                        displayDatabaseJobs();
                        updateStatistics();
                        showDefaultSkills();
                        document.getElementById('jobsContent').style.display = 'block';
                    } else {
                        document.getElementById('noJobsMessage').style.display = 'block';
                    }
                } else {
                    document.getElementById('noJobsMessage').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading database jobs:', error);
                document.getElementById('errorText').textContent = 'Error: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
            }
        }
        
        function showDefaultSkills() {
            if (allDatabaseJobs.length > 0) {
                // Get the most recent job (first one since they're ordered by creation date)
                const mostRecentJob = allDatabaseJobs[0];
                const skillsData = getSkillsFromJob(mostRecentJob);
                const filename = getFilenameFromJob(mostRecentJob);
                
                if (skillsData) {
                    document.getElementById('skillsInfo').style.display = 'block';
                    document.querySelector('.skills-display h4').innerHTML = 
                        `<i class="fa fa-tags"></i> Skills from Latest Upload (${filename}):`;
                    document.getElementById('skillsContainer').innerHTML = formatSkillsDisplay(skillsData);
                    currentSkills = skillsData;
                } else {
                    document.getElementById('skillsInfo').style.display = 'none';
                }
            }
        }
        

        // Helper function to get filename from job
        function getFilenameFromJob(job) {
            return job.filename || 'Unknown';
        }
        
        function getSkillsFromJob(job) {
            return job.skills || '';
        }
        
        
        // Display jobs in table
        function displayDatabaseJobs() {
            const tableBody = document.getElementById('jobsTableBody');
            const tableInfo = document.getElementById('tableInfo');
            
            if (displayedJobs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No jobs match your current filters</td></tr>';
                tableInfo.textContent = 'No jobs to display';
                return;
            }
            
            tableBody.innerHTML = displayedJobs.map((job, index) => `
                <tr data-job-index="${index}">
        
                    <td class="job-title-cell" title="${job.title || 'Job Title Not Available'}">
                        ${truncateText(job.title || 'Job Title Not Available', 30)}
                    </td>
                    <td class="job-company-cell">${job.company || 'Not Specified'}</td>
                    <td class="job-location-cell">${job.location || 'Not Specified'}</td>
                    <td class="job-source-cell">
                        <span class="source-badge">${job.source || 'Unknown'}</span>
                    </td>
                    <td class="job-salary-cell">${job.salary || 'Not Listed'}</td>
                    <td class="job-date-cell">${formatDate(job.postedDate) || 'Not Available'}</td>

                </tr>
            `).join('');
            
            tableInfo.textContent = `Showing ${displayedJobs.length} job${displayedJobs.length !== 1 ? 's' : ''}`;
            document.getElementById('displayedJobs').textContent = displayedJobs.length;
        }
        
        // Update statistics
        function updateStatistics() {
            document.getElementById('totalJobs').textContent = allDatabaseJobs.length;
            document.getElementById('totalSources').textContent = "1"; //allSources.length;
        }

        function searchJobs() {
            applyAllFilters();
        }

        function applyAllFilters() {
            const selectedFilename = document.getElementById('filenameFilter').value;
            const selectedSource = document.getElementById('sourceFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            displayedJobs = allDatabaseJobs.filter(job => {
                // Filename filter
                if (selectedFilename !== 'all' && getFilenameFromJob(job) !== selectedFilename) {
                    return false;
                }
                
                // Source filter
                if (selectedSource !== 'all' && job.source !== selectedSource) {
                    return false;
                }
                
                // Search filter
                if (searchTerm && !jobMatchesSearch(job, searchTerm)) {
                    return false;
                }
                
                return true;
            });
            
            displayDatabaseJobs();
            updateStatistics();
        }

        function jobMatchesSearch(job, searchTerm) {
            const searchFields = [
                job.title || '',
                job.company || '',
                job.location || '',
                getFilenameFromJob(job) || ''
            ];
            
            return searchFields.some(field => 
                field.toLowerCase().includes(searchTerm)
            );
        }

        // Utility functions (same as before)
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        // Sort table function
        function sortTable(columnIndex) {
            const table = document.getElementById('jobsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            if (rows.length === 0 || rows[0].cells.length <= columnIndex) return;
            
            const currentHeader = table.querySelectorAll('th')[columnIndex];
            const isAscending = !currentHeader.classList.contains('sort-desc');
            
            // Clear all sort indicators
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                const icon = th.querySelector('i');
                if (icon) icon.className = 'fa fa-sort';
            });
            
            // Set new sort indicator
            currentHeader.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
            const icon = currentHeader.querySelector('i');
            if (icon) {
                icon.className = isAscending ? 'fa fa-sort-up' : 'fa fa-sort-down';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim().toLowerCase();
                const bValue = b.cells[columnIndex].textContent.trim().toLowerCase();
                
                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        async function clearDatabase() {
            if (!confirm('Are you sure you want to delete ALL jobs from the database? This cannot be undone.')) {
                return;
            }
            
            try {
                
                const response = await fetch('/db/api/jobs/clear', { method: 'DELETE' });
                
                if (response.ok) {
                    alert('Database cleared successfully');
                    loadDatabaseJobs();
                } else {
                    alert('Error clearing database');
                }
            } catch (error) {
                console.error('Error clearing database:', error);
                alert('Error clearing database');
            }
        }

        // Export functions
        function exportToCSV() {
            if (displayedJobs.length === 0) {
                alert('No jobs to export');
                return;
            }

            const headers = ['CV File', 'Title', 'Company', 'Location', 'Source', 'Salary', 'Posted Date', 'URL'];
            const csvContent = [
                headers.join(','),
                ...displayedJobs.map(job => [
                    `"${(getFilenameFromJob(job) || '').replace(/"/g, '""')}"`,
                    `"${(job.title || '').replace(/"/g, '""')}"`,
                    `"${(job.company || '').replace(/"/g, '""')}"`,
                    `"${(job.location || '').replace(/"/g, '""')}"`,
                    `"${(job.source || '').replace(/"/g, '""')}"`,
                    `"${(job.salary || '').replace(/"/g, '""')}"`,
                    `"${(job.postedDate || '').replace(/"/g, '""')}"`,
                    `"${(job.url || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'database_jobs.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printJobs() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Database Job Search Results</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 0.8em; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .source-badge { background: #e3f2fd; color: #1976d2; padding: 2px 4px; border-radius: 4px; font-size: 0.7em; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Database Job Search Results</h1>
                        <p><strong>Total Jobs:</strong> ${displayedJobs.length} | <strong>Export Date:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>CV File</th><th>Job Title</th><th>Company</th><th>Location</th>
                                <th>Source</th><th>Salary</th><th>Posted Date</th><th>Apply Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${displayedJobs.map(job => `
                                <tr>
                                    <td>${getFilenameFromJob(job) || 'Unknown'}</td>
                                    <td>${job.title || 'Not Available'}</td>
                                    <td>${job.company || 'Not Specified'}</td>
                                    <td>${job.location || 'Not Specified'}</td>
                                    <td><span class="source-badge">${job.source || 'Unknown'}</span></td>
                                    <td>${job.salary || 'Not Listed'}</td>
                                    <td>${formatDate(job.postedDate) || 'Not Available'}</td>
                                    <td>${job.url ? job.url : 'No Link'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Initialize page when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseJobs();
            
//            // Add search on Enter key
//            document.getElementById('searchInput').addEventListener('keypress', function(e) {
//                if (e.key === 'Enter') {
//                    searchJobs();
//                }
//            });
//            
        });
        
        
        
        
        
        
        
    </script>
 
</body>
</html>